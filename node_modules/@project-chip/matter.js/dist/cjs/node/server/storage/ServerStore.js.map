{
  "version": 3,
  "sources": ["../../../../../src/node/server/storage/ServerStore.ts"],
  "sourcesContent": ["/**\n * @license\n * Copyright 2022-2024 Matter.js Authors\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport { Destructable } from \"../../../common/Lifecycle.js\";\nimport { ImplementationError } from \"../../../common/MatterError.js\";\nimport { Environment } from \"../../../environment/Environment.js\";\nimport { StorageService } from \"../../../environment/StorageService.js\";\nimport { Diagnostic } from \"../../../log/Diagnostic.js\";\nimport { Logger } from \"../../../log/Logger.js\";\nimport { EventHandler } from \"../../../protocol/interaction/EventHandler.js\";\nimport { StorageContext } from \"../../../storage/StorageContext.js\";\nimport { StorageManager } from \"../../../storage/StorageManager.js\";\nimport { Construction, asyncNew } from \"../../../util/Construction.js\";\nimport { PartStoreFactory, PartStoreService } from \"./PartStoreService.js\";\n\nconst logger = Logger.get(\"ServerStore\");\n\n/**\n * Non-volatile state management for a {@link NodeServer}.\n *\n * The default implementation for matter.js uses synchronous APIs for storage. However, this will change in the future,\n * and other implementations may be backed by asynchronous storage.  So the public API is asynchronous.\n */\nexport class ServerStore implements Destructable {\n    #location: string;\n    #nodeId: string;\n    #storageManager?: StorageManager;\n    #eventHandler?: EventHandler;\n    #sessionStorage?: StorageContext;\n    #fabricStorage?: StorageContext;\n    #eventStorage?: StorageContext;\n    #rootStore?: PartStoreFactory;\n    #construction: Construction<ServerStore>;\n\n    get construction() {\n        return this.#construction;\n    }\n\n    /**\n     * Create a new store.\n     *\n     * TODO - implement conversion from 0.7 format so people can change API seamlessly\n     */\n    constructor(environment: Environment, nodeId?: string) {\n        if (nodeId === undefined) {\n            throw new ImplementationError(\"ServerStore must be created with a nodeId\");\n        }\n\n        const storage = environment.get(StorageService);\n        this.#location = storage.location ?? \"(unknown location)\";\n        this.#nodeId = nodeId;\n\n        const initializeStorage = async () => {\n            this.#storageManager = await storage.open(nodeId);\n\n            this.#rootStore = await asyncNew(PartStoreFactory, {\n                storage: this.#storageManager.createContext(\"root\"),\n            });\n\n            this.#eventStorage = this.#storage.createContext(\"events\");\n            this.#eventHandler = await EventHandler.create(this.eventStorage);\n\n            this.#logChange(\"Opened\");\n        };\n\n        this.#construction = Construction(this, initializeStorage);\n    }\n\n    static async create(environment: Environment, nodeId: string) {\n        return await asyncNew(this, environment, nodeId);\n    }\n\n    async erase() {\n        await this.#sessionStorage?.clearAll();\n        await this.#fabricStorage?.clearAll();\n        await this.#eventStorage?.clearAll();\n        await this.#rootStore?.erase();\n    }\n\n    async close() {\n        await this.#construction.close(async () => {\n            await this.#storageManager?.close();\n            this.#logChange(\"Closed\");\n        });\n    }\n\n    get eventStorage() {\n        if (!this.#eventStorage) {\n            throw new ImplementationError(\"Event storage accessed prior to initialization\");\n        }\n        return this.#eventStorage;\n    }\n\n    get eventHandler() {\n        if (!this.#eventHandler) {\n            throw new ImplementationError(\"Event handler accessed prior to initialization\");\n        }\n        return this.#eventHandler;\n    }\n\n    get sessionStorage() {\n        if (!this.#sessionStorage) {\n            this.#sessionStorage = this.#storage.createContext(\"sessions\");\n        }\n        return this.#sessionStorage;\n    }\n\n    get fabricStorage() {\n        if (!this.#fabricStorage) {\n            this.#fabricStorage = this.#storage.createContext(\"fabrics\");\n        }\n        return this.#fabricStorage;\n    }\n\n    get partStores(): PartStoreService {\n        if (this.#rootStore === undefined) {\n            throw new ImplementationError(\"Endpoint storage accessed prior to initialization\");\n        }\n        return this.#rootStore;\n    }\n\n    get #storage() {\n        if (this.#storageManager === undefined) {\n            throw new ImplementationError(\"Node storage accessed prior to initialization\");\n        }\n        return this.#storageManager;\n    }\n\n    #logChange(what: \"Opened\" | \"Closed\") {\n        logger.info(what, Diagnostic.strong(this.#nodeId ?? \"node\"), \"storage at\", `${this.#location}/${this.#nodeId}`);\n    }\n}\n"],
  "mappings": "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",
  "names": []
}
