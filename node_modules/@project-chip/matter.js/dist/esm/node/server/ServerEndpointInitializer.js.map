{
  "version": 3,
  "sources": ["../../../../src/node/server/ServerEndpointInitializer.ts"],
  "sourcesContent": ["/**\n * @license\n * Copyright 2022-2024 Matter.js Authors\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport { Behavior } from \"../../behavior/Behavior.js\";\nimport { DescriptorServer } from \"../../behavior/definitions/descriptor/DescriptorServer.js\";\nimport { BehaviorBacking } from \"../../behavior/internal/BehaviorBacking.js\";\nimport { InternalError } from \"../../common/MatterError.js\";\nimport { Endpoint } from \"../../endpoint/Endpoint.js\";\nimport { EndpointServer } from \"../../endpoint/EndpointServer.js\";\nimport { EndpointInitializer } from \"../../endpoint/properties/EndpointInitializer.js\";\nimport { Environment } from \"../../environment/Environment.js\";\nimport { Logger } from \"../../log/Logger.js\";\nimport { ServerStore } from \"./storage/ServerStore.js\";\n\nconst logger = Logger.get(\"BehaviorInit\");\n\nexport class ServerEndpointInitializer extends EndpointInitializer {\n    #store: ServerStore;\n\n    constructor(environment: Environment) {\n        super();\n        this.#store = environment.get(ServerStore);\n    }\n\n    override initializeDescendent(endpoint: Endpoint) {\n        if (!endpoint.lifecycle.hasId) {\n            endpoint.id = this.#identifyPart(endpoint);\n        }\n\n        this.#store.partStores.assignNumber(endpoint);\n\n        endpoint.behaviors.require(DescriptorServer);\n    }\n\n    /**\n     * If a {@link Endpoint} does not yet have a {@link EndpointServer}, create one now, then create a\n     * {@link BehaviorBacking} for a specific {@link Behavior}.\n     *\n     * This is where we adapt endpoints and behaviors for a server role.\n     */\n    createBacking(endpoint: Endpoint, behavior: Behavior.Type): BehaviorBacking {\n        return EndpointServer.forEndpoint(endpoint).createBacking(behavior);\n    }\n\n    /**\n     * Select an ID for an endpoint automatically based on available metadata.\n     */\n    #identifyPart(endpoint: Endpoint) {\n        const basicInfo =\n            endpoint.behaviors.supported.basicInformation ?? endpoint.behaviors.supported.bridgedDeviceBasicInformation;\n        if (basicInfo) {\n            const defaults = {\n                ...new basicInfo.State(),\n                ...endpoint.behaviors.defaultsFor(basicInfo),\n            };\n\n            let id = (defaults as Record<string, string>).uniqueId;\n            if (id) {\n                return id;\n            }\n\n            id = (defaults as Record<string, string>).serialNumber;\n            if (id) {\n                return id;\n            }\n        }\n\n        if (!(endpoint.owner instanceof Endpoint)) {\n            throw new InternalError(\"Cannot determine ID for endpoint with unknown parent type\");\n        }\n        if (!endpoint.owner.lifecycle.hasId) {\n            throw new InternalError(\"Cannot determine ID for endpoint because parent has no ID\");\n        }\n\n        const index = endpoint.owner.parts.indexOf(endpoint);\n        if (index === -1) {\n            throw new InternalError(\"Cannot determine ID for endpoint because parent does not list as child\");\n        }\n\n        // Use \"part\" rather than \"endpoint\" because it is scoped within parent endpoint\n        const id = `part${index}`;\n        logger.warn(`Using fallback ID of ${id} for child of ${endpoint.owner}; assign ID to remove this warning`);\n\n        return id;\n    }\n}\n"],
  "mappings": "AAAA;AAAA;AAAA;AAAA;AAAA;AAOA,SAAS,wBAAwB;AAEjC,SAAS,qBAAqB;AAC9B,SAAS,gBAAgB;AACzB,SAAS,sBAAsB;AAC/B,SAAS,2BAA2B;AAEpC,SAAS,cAAc;AACvB,SAAS,mBAAmB;AAE5B,MAAM,SAAS,OAAO,IAAI,cAAc;AAEjC,MAAM,kCAAkC,oBAAoB;AAAA,EAC/D;AAAA,EAEA,YAAY,aAA0B;AAClC,UAAM;AACN,SAAK,SAAS,YAAY,IAAI,WAAW;AAAA,EAC7C;AAAA,EAES,qBAAqB,UAAoB;AAC9C,QAAI,CAAC,SAAS,UAAU,OAAO;AAC3B,eAAS,KAAK,KAAK,cAAc,QAAQ;AAAA,IAC7C;AAEA,SAAK,OAAO,WAAW,aAAa,QAAQ;AAE5C,aAAS,UAAU,QAAQ,gBAAgB;AAAA,EAC/C;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQA,cAAc,UAAoB,UAA0C;AACxE,WAAO,eAAe,YAAY,QAAQ,EAAE,cAAc,QAAQ;AAAA,EACtE;AAAA;AAAA;AAAA;AAAA,EAKA,cAAc,UAAoB;AAC9B,UAAM,YACF,SAAS,UAAU,UAAU,oBAAoB,SAAS,UAAU,UAAU;AAClF,QAAI,WAAW;AACX,YAAM,WAAW;AAAA,QACb,GAAG,IAAI,UAAU,MAAM;AAAA,QACvB,GAAG,SAAS,UAAU,YAAY,SAAS;AAAA,MAC/C;AAEA,UAAIA,MAAM,SAAoC;AAC9C,UAAIA,KAAI;AACJ,eAAOA;AAAA,MACX;AAEA,MAAAA,MAAM,SAAoC;AAC1C,UAAIA,KAAI;AACJ,eAAOA;AAAA,MACX;AAAA,IACJ;AAEA,QAAI,EAAE,SAAS,iBAAiB,WAAW;AACvC,YAAM,IAAI,cAAc,2DAA2D;AAAA,IACvF;AACA,QAAI,CAAC,SAAS,MAAM,UAAU,OAAO;AACjC,YAAM,IAAI,cAAc,2DAA2D;AAAA,IACvF;AAEA,UAAM,QAAQ,SAAS,MAAM,MAAM,QAAQ,QAAQ;AACnD,QAAI,UAAU,IAAI;AACd,YAAM,IAAI,cAAc,wEAAwE;AAAA,IACpG;AAGA,UAAM,KAAK,OAAO,KAAK;AACvB,WAAO,KAAK,wBAAwB,EAAE,iBAAiB,SAAS,KAAK,oCAAoC;AAEzG,WAAO;AAAA,EACX;AACJ;",
  "names": ["id"]
}
